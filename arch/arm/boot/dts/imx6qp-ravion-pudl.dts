/*
 * Copyright 2025 Radioavionica Corp.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 as
 * published by the Free Software Foundation.
 *
 */

/dts-v1/;
#include "imx6qp.dtsi"

#define SPI_CS_GPIO
#include "imx6qdl-ravion-v2.dtsi"

/ {
	model = "ravion:pudl";
	compatible = "ravion,imx6qp", "fsl,imx6qp";

	/*
	 * Device specific regulators
	 */
	reg_p5vg: regulator-p5v { /* DA4 */
			compatible = "regulator-fixed";
			regulator-name = "P5V";
			regulator-min-microvolt = <5000000>;
			regulator-max-microvolt = <5000000>;
			regulator-boot-on;
			regulator-always-on;
	};

	reg_p3v3: regulator-p3v3 { /* DA3 */
			compatible = "regulator-fixed";
			regulator-name = "P3V3";
			regulator-min-microvolt = <3300000>;
			regulator-max-microvolt = <3300000>;
			regulator-boot-on;
			regulator-always-on;
	};

	reg_tlv_p1v8: regulator-tlv { /* DA7 */
			compatible = "regulator-fixed";
			regulator-name = "TLV-P1V8";
			regulator-min-microvolt = <1800000>;
			regulator-max-microvolt = <1800000>;
			vin-supply = <&reg_p3v3>;
			regulator-boot-on;
			regulator-always-on;
	};

	sound-tlv320 {
		compatible = "fsl,imx-audio-tlv320aic32x4";
		model = "ravion-tlv320aic32x6";
		ssi-controller = <&ssi2>;
		audio-codec = <&tlv320aic3206>;
		audio-routing =
			"IN1_L", "Line In Jack",
			"IN1_R", "Line In Jack",
			"IN2_L", "Line In Jack",
			"IN2_R", "Line In Jack",
			"Headphone Jack", "HPL",
			"Headphone Jack", "HPR",
			"Line Out Jack", "LOL",
			"Line Out Jack", "LOR";
		mux-int-port = <2>;
		mux-ext-port = <5>;
	};

	pps {
		compatible = "pps-gpio";
		gpios	= <&gpio1  2 GPIO_ACTIVE_LOW>;		/* soDimm055 */
	};

	gpio-keys {
		compatible = "gpio-keys";

		PTT1 {
			label = "TNG1";
			gpios = <&gpio2 31 GPIO_ACTIVE_LOW>;	/* soDimm37 */
			linux,code = <KEY_F2>;
			debounce-interval = <100>;
			wakeup-source;
		};

		PTT2 {
			label = "TNG2";
			gpios = <&gpio3 25 GPIO_ACTIVE_LOW>;	/* soDimm29 */
			linux,code = <KEY_F10>;
			debounce-interval = <100>;
			wakeup-source;
		};
	};

	gpio-keys-front-panel { //TODO: make interrupts work
		compatible = "gpio-keys-polled";
		poll-interval = <100>;
		button1 {
			label = "BS";
			gpios = <&i2c_mux 10 GPIO_ACTIVE_LOW>;
			linux,code = <KEY_F17>;
		};

		button2 {
			label = "RS1";
			gpios = <&i2c_mux 15 GPIO_ACTIVE_LOW>;
			linux,code = <KEY_F18>;
		};

		button3 {
			label = "RS2";
			gpios = <&i2c_mux 14 GPIO_ACTIVE_LOW>;
			linux,code = <KEY_F19>;
		};
	};

	button-backlight {
		compatible = "pwm-backlight";
		pwms = <&pwm3 0 5000000>;
		brigthness-levels = <0 4 8 16 32 64 128 255>;
		default-brightnesslevel = <2>;
	};

	gpio-leds {
		compatible = "gpio-leds";

		LED1 { /* P1_5 */
			label = "rs1::blue";
			gpios = <&i2c_mux 13 GPIO_ACTIVE_HIGH>;
			default-stat = "off";
		};

		LED2 { /* P1_4 */
			label = "rs1::green";
			gpios = <&i2c_mux 12 GPIO_ACTIVE_HIGH>;
			default-stat = "off";
		};

		LED3 { /* P0_6 */
			label = "rs2::blue";
			gpios = <&i2c_mux 6 GPIO_ACTIVE_HIGH>;
			default-stat = "off";
		};

		LED4 { /* P0_7 */
			label = "rs2::green";
			gpios = <&i2c_mux 7 GPIO_ACTIVE_HIGH>;
			default-stat = "off";
		};

		LED5 { /* P1_0 */
			label = "bs::green";
			gpios = <&i2c_mux 8 GPIO_ACTIVE_HIGH>;
			default-stat = "off";
		};

		LED6 { /* P1_1 */
			label = "bs::blue";
			gpios = <&i2c_mux 9 GPIO_ACTIVE_HIGH>;
			default-stat = "off";
		};

		status_red {
			label = "status::red";
			gpios = <&gpio1 4 GPIO_ACTIVE_HIGH>;	/* soDimm188 */
			default-state = "off";
		};

		status_green {
			label = "status::green";
			gpios = <&gpio4 7 GPIO_ACTIVE_HIGH>;	/* soDimm190 */
			default-state = "off";
		};

		status_blue {
			label = "status::blue";
			linux,default-trigger = "heartbeat";
			gpios = <&gpio5 20 GPIO_ACTIVE_HIGH>;	/* soDimm192 */
			default-state = "on";
		};
	};
};

/*
 * Serial ports
 */
/* &uart1 {	status = "okay";	}; => Allways enabled */
&uart2 {
	uart-has-rtscts;
	status = "okay";

	bluetooth {
		enable-gpios = <&gpio3 20 GPIO_ACTIVE_HIGH>;	/* soDimm 027 */
		compatible = "ti,wl1837-st";
		clocks = <&clk_32k_bt 0>;
		clock-names = "ext_clock";
		max-speed = <3686400>;
		current-speed = <115200>;
		status = "okay";

		clk_32k_bt: bt_clk {
			compatible = "fixed-clock";
			#clock-cells = <0>;
			clock-frequency = <32768>;
			clock-accuracy = <100>;
		};
	};
};

&uart3 {
	status = "okay";
};

/*
 * Controller Area Network (CAN) Bus
 */
&can1 {
	status = "okay";
};

/*
 * I2C Busses
 */
&i2c2 {	/* Compatible I2C: soDimm 194, 196 */
	status = "okay";

	/* ext codec */
	#address-cells = <1>;
	#size-cells = <0>;
	tlv320aic3206: codec@18 {
		compatible = "ti,tlv320aic32x6";
		reg = <0x18>;
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_ext_aud5>, <&pinctrl_clkext>;
		iov-supply = <&reg_p3v3>;
		av-supply = <&reg_tlv_p1v8>;
		dv-supply = <&reg_tlv_p1v8>;
//		reset-gpios = <>; /* Not connected */
		clocks = <&clks IMX6QDL_CLK_CKO2>; /* soDimm 137 */
		clock-names = "mclk";
	};
};

&i2c3 { /* Extended I2C: soDimm 128, 130 */
	status = "okay";

	#address-cells = <1>;
	#size-cells = <0>;
	i2c_mux: pca9575@20 {
		compatible = "nxp,pca9575";
		reg = <0x20>;
		pinctrl-names = "default";
		/* pinctrl-0 = <&pinctrl_hog>; */
		gpio-controller;
		#gpio-cells = <2>;
		interrupt-parent = <&gpio7>;
		interrupts = <13 IRQ_TYPE_EDGE_FALLING>; /*sodimm 186 */
		interrupt-controller;
		#interrupt-cells = <2>;
		//sw-gpios = <&i2c_mux 10 0>;
		gpio-line-names =
			"__unused_p00", "__unused_p01", "__unused_p02", "__unused_p03",
			"__unused_p04", "__unused_p05", "led2", "led1",
			"led9", "led10", "led7", "led8",
			"led5", "led6", "led3", "led4";
	};
};

&mipi_csi {
	status = "disabled";
};

/*
 * SD/MMC and eMMC controllers
 */
&usdhc1 {	status = "okay";	}; /* compatible */
&usdhc2 {	status = "okay";	}; /* compatible */
/* &usdhc3 {	status = "okay";	}; => eMMC allways enabled */

/*
 * Ethernet controller
 */
/* &fec {	status = "okay";	}; => eth0 allways enabled */

/*
 * Audio (digital part)
 */
/* &audmux {	status = "okay";	}; => Allways enabled */
&sgtl5000 {	status = "disabled";	};
&module_sound {	status = "disabled";	};
&ssi1	{	status = "disabled";	};
&ssi2 	{	status = "okay";	}; /* for external codec */

&usbotg	{ /* OTG */
	status = "okay";
};

/*
 * PWMs
 */
&pwm3	{
	status = "okay";
	#pwm-cells = <2>;
};

&pwm4	{	status = "disabled";	};

&iomuxc {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_hog>, <&pinctrl_uart1gpio>;
};
